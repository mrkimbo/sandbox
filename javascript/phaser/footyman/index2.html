<!DOCTYPE html>
<html>
<head>
  <title></title>
  <script src="js/phaser.min.js"></script>
</head>
<body>
<script type="text/javascript">

  var game;

  function init()
  {
    game = new Phaser.Game(800, 256, Phaser.AUTO, '', {
      preload: preload, // initial preload
      loadUpdate: onLoadProgress, // load progress updates
      create: create, // initial render
      update: update, // pre-redraw
      render: null // post-redraw
    });
    var scroll_spd = 5, walking = false, THROW_SPD = 500;
    var bounds, backdrop, ball, hero, bounce, kickAnim;
    var input;
    var ballAnim = {
      vx: 0,
      vy: 0
    }

    function preload()
    {
      log('preload()');
      game.load.atlas('hero', 'img/soccerman.png', 'img/soccerman.array.json');
      game.load.image('backdrop', 'img/backdrop.png');
      game.load.image('ball', 'img/ball.png');
    }

    function onLoadProgress()
    {
      log('loadProgress: ' + game.load.progress);
    }

    function create()
    {
      log('create()');

      initWorld();
      renderGameElements();
      startGame();
    }

    function initWorld()
    {
      game.world.setBounds(0,0,1000,256);

      input = {
        left: game.input.keyboard.addKey(Phaser.Keyboard.LEFT),
        right: game.input.keyboard.addKey(Phaser.Keyboard.RIGHT),
        space: game.input.keyboard.addKey(Phaser.Keyboard.SPACEBAR)
      };

      game.camera.x = (game.world.width-game.width)*.5;
    }

    function renderGameElements()
    {
      var w = 0, s, p = 0;
      backdrop = game.add.group();
      while (w < game.world.width)
      {
        s = backdrop.create(320 * (p++), 0, 'backdrop');
        w += s.width;
      }

      bounds = game.add.group();



      hero = game.add.sprite(0, game.world.height, 'hero');
      hero.anchor.setTo(.5, 1);

      hero.animations.add('kick', ['kick'], 0, false, false);
      hero.animations.add('idle', ['idle'], 0, false, false);
      hero.animations.add(
        'walk', ['run1', 'run2', 'run3', 'run4', 'run5'], 24, true, false
      );

      ball = game.add.sprite(0, game.world.height - 36, 'ball');
      ball.anchor.setTo(.5, .5);
      ball.body.setSize(40,40);
      //ball.physics.gravity.y = 15;


      bounce = game.add.tween(ball);
      bounce
        .to({ y: game.world.height - 60 }, 250, Phaser.Easing.Quadratic.Out)
        .to({ y: game.world.height - 36 }, 250, Phaser.Easing.Quadratic.In)
        .loop();
    }

    function startGame()
    {
      // initial positions //
      hero.x = game.camera.x + (game.width *.5) - 20;
      ball.x = game.camera.x + (game.width *.75);

      //hero.fixedToCamera = true;

      //bounce.start();

      //game.input.onDown.add(kickBall, this);

      // start off in idle mode //
      hero.animations.play('idle');
    }

    /*var diffX;
    function follow()
    {
      diffX = ball.x - hero.x;
      if (diffX > 45)
      {
        if (currentAnim() == 'idle')
        {
          hero.animations.play('walk');
        }
        ball.x -= 6;
      } else {
        hero.animations.play('idle');
        ball.x = hero.x + 45;
      }
    }*/

    function kickBall()
    {
      walking = false;

      hero.animations.play('kick');
      setTimeout(function(){
        hero.animations.play('idle');
      },120);

      // if ball is within range, kick it //
      if(Math.abs(hero.x-ball.x) < 30)
      {
        // facing ball ? //
        if((ball.x-hero.x > 0 && hero.scale.x > 0) ||
          ((ball.x-hero.x < 0 && hero.scale.x < 0)))
        {
          log('kicked ball');

          var dir = new Phaser.Point(
            (Math.random()*game.width) - ball.center.x,
            (Math.random()*game.height) - ball.center.y
          );
          dir = dir.normalize();

          ball.body.velocity.x = THROW_SPD * dir.x;
          ball.body.velocity.y = THROW_SPD * dir.y;

          ball.body.allowGravity = true;

        }
      }
    }

    function kickComplete()
    {
      bounce.pause();
      ball.y = game.world.height - 36;
    }

    function handleInput()
    {
      if(currentAnim() != 'kick' && input.space.isDown)
      {
        kickBall();
      }

      if(input.left.isDown){
        game.camera.x -= scroll_spd;
        hero.x -= scroll_spd;
        hero.scale.x = -1;

        if(hero.x < 15) hero.x = 15;
      }
      if(input.right.isDown){
        game.camera.x += scroll_spd;
        hero.x += scroll_spd;
        hero.scale.x = 1;

        if(hero.x > game.world.width-15) hero.x = game.world.width-15;
      }

      walking = input.left.isDown || input.right.isDown;

      //log(game.camera.x);
    }

    function setHeroState()
    {
      if(currentAnim() == 'kick') return;

      if(walking)
      {
        if(currentAnim() != 'walk')
        {
          hero.animations.play('walk');
        }
      }
      else {
        hero.animations.play('idle');
      }
    }

    function update()
    {
      //follow();
      handleInput();
      setHeroState();
    }

    function currentAnim()
    {
      return hero.animations.currentAnim.name;
    }
  }

  window.onload = init;

</script>
</body>
</html>