"use strict";function bind(a,b){if(arguments.length>2){var c=Array.prototype.slice.call(arguments,2);return function(){var d=Array.prototype.slice.call(arguments);return Array.prototype.unshift.apply(d,c),a.apply(b,d)}}return function(){return a.apply(b,arguments)}}function isDef(a){return"undefined"!=typeof a&&null!=a}function toArray(a){return isArray(a)?a:"undefined"==typeof a?[]:[a]}function each(a,b,c){if(null!=a)if(Array.forEach&&a.forEach===Array.forEach)a.forEach(b,c);else if(a.length===+a.length){for(var d=0,e=a.length;e>d;d++)if(b.call(c,a[d],d,a)==={})return}else for(var f in a)if(a.hasOwnProperty(f)&&b.call(c,a[f],f,a)==={})return}function findNodes(a,b){var c,d,e=[];for(c=0;c<a.children.length;c++)d=a.children[c],b(d)?e[e.length]=d:e=e.concat(findNodes(d,b));return e}function log(a,b){if(window.console&&window.console.log&&window.DEBUG!==!1){var c=(new Date).getTime();window.console.log(b?"[+"+(c-_ts)+" ms] "+a:a),_ts=c}}!function(){for(var a=["Array","Function","Object","String","Number"],b=a.length;b--;)window["is"+a[b]]=function(a){return function(b){return!!b&&Object.prototype.toString.call(b)==="[object "+a+"]"}}(a[b])}();var _ts=(new Date).getTime(),FeedLoader=function(a,b,c){this._rootURL=(a||"http://affiliate.sportsbet.com.au/xmlfeeds").replace(/\/?$/,"/"),this._cancelOnTimeout=c||!1,this._failTimeout=b||5,this._onFail=null,this._timeoutID=-1,this._requestTime=null,this._feedName="",Object.defineProperty(this,"feedName",{get:function(){return this._feedName}})};FeedLoader.prototype.load=function(a,b,c,d){if(this._feedName=this.getFeedName(a),!this._feedName)throw new Error("FeedLoader::load("+a+") - Error: Unknown ClassID");this._setLoadHandler(b);var e=document.createElement("script");e.id=this._feedName+"_jsnp",e.src=this._rootURL+this._feedName+".jsnp",this._onFail=c,this._timeoutID=setTimeout(bind(this._onTimeout,this,e.id,d),1e3*this._failTimeout),e.onerror=bind(function(){this._clearFeedTimeout(),c({target:this,duration:this.getLoadTime()})},this),e.onload=bind(function(){this._clearFeedTimeout()},this),this._requestTime=(new Date).getTime(),this._clearLoadHandler(e.id),document.body.appendChild(e)},FeedLoader.prototype.getFeedName=function(a){var b=parseInt(a);if(isNaN(b))return a;switch(b){case 1:case 2:return"Racing";case 5:return"RacingFutures";case 12:return"RugbyUnion";case 13:return"Tennis";case 25:return"Cricket";case 23:return"RugbyLeague";case 29:return"SoccerH2H";case 50:return"AussieRules";case 63:return"Basketball";case 104:return"Entertainment";default:return a}},FeedLoader.prototype._clearFeedTimeout=function(){try{clearTimeout(this._timeoutID)}catch(a){}},FeedLoader.prototype.getLoadTime=function(){return(new Date).getTime()-this._requestTime},FeedLoader.prototype._onTimeout=function(a,b){b&&b({target:this,duration:this.getLoadTime()}),this._cancelOnTimeout&&(document.getElementById(a).onerror=null,document.getElementById(a).onload=null,this._clearLoadHandler(a),this._onFail({target:this,duration:this.getLoadTime()}))},FeedLoader.prototype._clearLoadHandler=function(a){var b=document.getElementById(a);b&&(b.onerror=null,b.onload=null,b.parentNode.removeChild(b))},FeedLoader.prototype._setLoadHandler=function(a){this._clearFeedTimeout(),this._clearLoadHandler(),window.loadSportBetData=function(b){a&&a.call(null,b)}};var FeedModel=function(a){this._reset(),a&&this._init(a),Object.defineProperties(this,{data:{get:function(){return this._data},set:this._init}})};FeedModel.IGNORE_LIST=/limit|classID|market|postFilter/i,FeedModel.prototype._reset=function(){this._timestamp=null,this._competitions={},this._rounds={},this._events={},this._markets={},this._data=null},FeedModel.prototype._init=function(a){this._timestamp=new Date(a.Sportsbet.Time),this._parse(a),this._data=Object.hasOwnProperty("freeze")?this._data=Object.freeze(a):a},FeedModel.prototype._parse=function(a){if("object"==typeof a){var b;for(b in a)switch(b.toLowerCase()){case"competition":a[b]=toArray(a[b]),each(a[b],function(a){a.parent=null,this._competitions[a.CompetitionID]=a,this._parse(a)},this);break;case"round":a[b]=toArray(a[b]),each(a[b],function(b){b.parent=a,this._rounds[b.RoundID]=b,this._parse(b)},this);break;case"event":a[b]=toArray(a[b]),each(a[b],function(b){b.parent=a,this._events[b.EventID]=b,this._parse(b)},this);break;case"market":a[b]=toArray(a[b]),each(a[b],function(b){b.parent=a;var c=b.Type.toLowerCase();this._markets[c]||(this._markets[c]=[]),this._markets[c][this._markets[c].length]=b},this);break;case"parent":return}this._parse(a[b])}},FeedModel.prototype._reduce=function(a,b,c){if(log(this+"::reduce("+a.length+" items, ["+b+"], "+c+")"),!b.length)return a;var d,e;for(d=0;d<a.length;d++)e=!1,each(b,function(b){e||(e=this._compareValue(a[d],c,b))},this),e||a.splice(d--,1);return a},FeedModel.prototype._compareValue=function(a,b,c){var d=a;if(a){switch(b.replace(/id$/i,"").toLowerCase()){case"event":d=a.parent;break;case"round":d=a.parent.parent;break;case"competition":d=a.parent.parent.parent;break;default:d=this._evalPath(d,b.replace()),b=b.split(".").pop().toString()}b=b.charAt(0).toUpperCase()+b.substr(1);var e=!1;return isArray(d)?(each(d,function(a){e||(e=this._testProp(a,b,c))},this),e):this._testProp(d,b,c)}},FeedModel.prototype._evalPath=function(a,b){var c=b.split(".");for(c.pop();c.length;){if(!isDef(a[c[0]]))return null;a=a[c.shift()]}return a},FeedModel.prototype._testProp=function(a,b,c){return a&&a.hasOwnProperty(b)?a[b].toString().toLowerCase()==c.toString().toLowerCase():!1},FeedModel.prototype.filter=function(a){var b,c=[];each(this._markets,function(a){c=c.concat(toArray(a))},this),c=this._reduce(c,toArray(a.market),"Type");for(b in a)FeedModel.IGNORE_LIST.test(b)||(c=this._reduce(c,toArray(a[b]),b));return isDef(a.postFilter)&&(log(this+"::filter() - Applying post filter"),c=c.filter(a.postFilter)),isDef(a.limit)&&c.length>a.limit&&(log(this+"::filter() - limit("+a.limit+")"),c=c.slice(0,a.limit)),c},FeedModel.prototype.getCompetitionById=function(a){return this._competitions[a]},FeedModel.prototype.getRoundById=function(a){return this._rounds[a]},FeedModel.prototype.getEventById=function(a){return this._events[a]},FeedModel.prototype.getMarketsByType=function(a,b){if(!b)return this._markets[a];var c,d=[];for(c=0;c<b.length;c++)b[c].Type==a&&(d[d.length]=b[c]);return d},FeedModel.prototype.getFeedTimestamp=function(){return this._timestamp},FeedModel.prototype.toString=function(){return"FeedModel"};var FeedParser=function(a,b){this._config=null,this._loader=null,this._model=null,this._onSuccess=null,this._onFail=null,this._filterIdx=-1,this._timeout=a,this._cancelOnTimeout=b,Object.defineProperty(this,"_currentFilter",{get:function(){return this._config.filters[this._filterIdx]}})};FeedParser.VERSION="1.1.1",FeedParser.prototype.fetch=function(a,b,c,d){this._config=a,this._onSuccess=b,this._onFail=c,this._onTimeout=d,this._checkConfig()&&(this._loader=new FeedLoader(this._config.url,this._timeout,this._cancelOnTimeout),this._processNextFilter())},FeedParser.prototype._checkConfig=function(){if(!isDef(this._config))throw new Error(this+"::checkConfig() - Error: no config provided");if(this._config.filters=toArray(this._config.filters),!this._config.filters.length)throw new Error(this+"::checkConfig() - Error: no filters provided");return this._config.filters.forEach(function(a){a.limit=parseInt(a.limit)||void 0},this),!0},FeedParser.prototype._processNextFilter=function(){this._filterIdx++,log(this+"::_processNextFilter()"),log(this._currentFilter);var a=toArray(this._currentFilter.classID);if(!a.length)throw new Error(this+"::_processNextFilter() - Error: "+'no "classID" provided for filter['+this._filterIdx+"]");a=a[0],this._model&&this._loader.getFeedName(a)==this._loader.feedName?this._applyFilter():this._loader.load(this._currentFilter.classID,bind(this._loadComplete,this),this._onFail,this._onTimeout)},FeedParser.prototype._loadComplete=function(a){log(this+"::loadComplete()"),this._model||(this._model=new FeedModel),this._model.data=a,this._applyFilter()},FeedParser.prototype._applyFilter=function(){var a=this._model.filter(this._currentFilter);return a.length?(this._complete(a),void 0):this._filterIdx<this._config.filters.length-1?(this._processNextFilter(),void 0):(this._complete(a),void 0)},FeedParser.prototype._complete=function(a){log(this+"::complete("+a.length+" items)"),this._onSuccess.call(null,a,this._filterIdx)},FeedParser.prototype.getConfig=function(){return this._config},FeedParser.prototype.getModel=function(){return this._model},FeedParser.prototype.toString=function(){return"FeedParser"};